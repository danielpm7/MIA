<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ChatGPT Voz</title>
</head>
<body>
  <button id="start">üé§ Iniciar Grabaci√≥n</button>
  <button id="stop" disabled>‚èπÔ∏è Detener Grabaci√≥n</button>
  <p id="status"></p>
  <audio id="player" controls style="width:100%"></audio>

  <script>
    const startBtn  = document.getElementById("start");
    const stopBtn   = document.getElementById("stop");
    const statusTxt = document.getElementById("status");
    const player    = document.getElementById("player");
    const webhookUrl = "https://hook.us2.make.com/1ukimadzz3lav967g37b7j46gvpry3al";

    let mediaRecorder, audioChunks = [];

    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      // Auto-stop tras 20s para no mandar clips gigantes
      setTimeout(() => {
        if (mediaRecorder.state === "recording") stopBtn.click();
      }, 20000);

      mediaRecorder.start();
      statusTxt.textContent = "üî¥ Grabando‚Ä¶";
      startBtn.disabled = true;
      stopBtn.disabled  = false;
    };

    stopBtn.onclick = async () => {
      mediaRecorder.stop();
      statusTxt.textContent = "‚è≥ Enviando audio‚Ä¶";
      startBtn.disabled = true;
      stopBtn.disabled  = true;

      // Esperamos a que onstop se dispare
      mediaRecorder.onstop = async () => {
        try {
          // 1) Usa el mimeType real
          const mime = mediaRecorder.mimeType || "audio/webm";
          const blob = new Blob(audioChunks, { type: mime });
          // 2) Saca la extensi√≥n tras la '/'
          const ext  = mime.split("/")[1].split(";")[0]; 
          const name = `audio.${ext}`;

          // 3) Empaqueta y env√≠a
          const form = new FormData();
          form.append("file", blob, name);

          const res = await fetch(webhookUrl, { method: "POST", body: form });

          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }

          // 4) Recibe el MP3 y lo reproduce
          const mp3Blob = await res.blob();
          const url     = URL.createObjectURL(mp3Blob);
          player.src    = url;
          await player.play();

          statusTxt.textContent = "‚úÖ ¬°Reproduciendo respuesta!";
        } catch (err) {
          console.error(err);
          statusTxt.textContent = `‚ùå ${err.message}`;
        } finally {
          startBtn.disabled = false;
          stopBtn.disabled  = true;
        }
      };
    };
  </script>
</body>
</html>
