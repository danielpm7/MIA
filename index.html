<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ChatGPT Voz</title>
</head>
<body>
  <h2>ğŸ™ï¸ Grabar Audio y Enviar a Make</h2>
  <button id="start">ğŸ¤ Iniciar GrabaciÃ³n</button>
  <button id="stop" disabled>â¹ï¸ Detener GrabaciÃ³n</button>
  <p id="status"></p>

  <h2>ğŸ”Š Respuesta hablada</h2>
  <audio id="player" controls style="width:100%;"></audio>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const startBtn   = document.getElementById("start");
    const stopBtn    = document.getElementById("stop");
    const statusText = document.getElementById("status");
    const player     = document.getElementById("player");

    // â–¶ï¸ Tu URL de Custom Webhook en Make:
    const webhookUrl = "https://hook.us2.make.com/1ukimadzz3lav967g37b7j46gvpry3al";

    startBtn.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => {
          if (e.data && e.data.size > 0) audioChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          statusText.textContent = "â³ Enviando audioâ€¦";
          try {
            // 1. Empaqueta audio en FormData
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const formData  = new FormData();
            formData.append('file', audioBlob, 'audio.webm');

            // 2. EnvÃ­a al webhook
            const response = await fetch(webhookUrl, {
              method: 'POST',
              body: formData
            });
            console.log('Fetch status:', response.status);

            // 3. Clona y lee texto para debug
            const clone = response.clone();
            const text  = await response.text();
            console.log('Fetch body text (debug):', text);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${text}`);
            }

            // 4. Lee el MP3 desde la copia
            const mp3Blob = await clone.blob();
            const audioUrl = URL.createObjectURL(mp3Blob);

            // 5. Reproduce
            player.src = audioUrl;
            await player.play();
            statusText.textContent = "âœ… Respuesta recibida y reproducida.";
          } catch (err) {
            console.error('Error enviando o reproduciendo:', err);
            statusText.textContent = `âŒ ${err.message}`;
          } finally {
            startBtn.disabled = false;
            stopBtn.disabled  = true;
          }
        };

        // Comienza a grabar
        mediaRecorder.start();
        statusText.textContent = "ğŸ”´ Grabandoâ€¦";
        startBtn.disabled = true;
        stopBtn.disabled  = false;
      } catch (err) {
        console.error("Error al acceder al micrÃ³fono:", err);
        statusText.textContent = `âŒ ${err.message}`;
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        statusText.textContent = "â¹ï¸ Procesando grabaciÃ³n...";
        stopBtn.disabled = true;
      }
    };
  </script>
</body>
</html>